<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–°—Ç–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–π</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#667eea,#764ba2);
  height:100vh;
  overflow:hidden;
}

.stars { position:fixed; inset:0; pointer-events:none; z-index:0; }
.star {
  position:absolute;
  width:2px;height:2px;
  background:white;border-radius:50%;
  opacity:.5;
}

.title {
  position:fixed;
  top:20px; left:50%;
  transform:translateX(-50%);
  color:white; font-size:12px;
  font-weight:bold;
  z-index:10;
}

.container { position:absolute; inset:0; z-index:1; }

.flight-zone {
  position:absolute;
  left:0; right:0; top:0;
  overflow:hidden;
}

.wish-card {
  position:absolute;
  max-width:250px;
  padding:8px 10px 6px;
  background:rgba(255,255,255,.95);
  border-radius:10px;
  box-shadow:0 10px 30px rgba(0,0,0,.3);
  font-size:10px;
  will-change: transform;
  touch-action: none; /* –≤–∞–∂–Ω–æ –¥–ª—è drag –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
  user-select: none;
}

.wish-emoji {
  position:absolute;
  top:-7px; right:-10px;
  font-size:16px;
}

.wish-text { line-height:1.4; margin-bottom:6px; }
.wish-author { font-size:11px; color:#555; text-align:right; }

.input-container {
  position:fixed;
  left:0; right:0; bottom:0;
  padding:16px 24px;
  backdrop-filter:blur(20px);
  background:rgba(255,255,255,.15);
  z-index:20;
}

.input-wrapper {
  max-width:800px;
  margin:0 auto;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}

input, textarea {
  flex:1;
  padding:12px;
  border:none;
  border-radius:14px;
}

textarea { flex-basis:100%; resize:none; }

button {
  width:100%;
  padding:12px;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg,#f093fb,#f5576c);
  color:white;
  font-weight:bold;
}

.logo {
  position: absolute;
  top:-30px;
  left: -20px;
  z-index: 1000;
}
.logo-img{
  width: 100px;
}
</style>
</head>
<body>
<div class="logo">
  <img class="logo-img" src="./Logo-NEX">
</div>
<div class="stars" id="stars"></div>
<div class="title">–ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Ç–µ–±—è!!!</div>

<div class="container">
  <div class="flight-zone" id="flightZone"></div>
</div>

<div class="input-container" id="inputBar">
  <div class="input-wrapper">
    <input id="nameInput" placeholder="–í–∞—à–µ –∏–º—è">
    <textarea id="wishInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="200"></textarea>
    <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyC_iRQRECuIMxVbcZxSqAOfVaR4EasniSQ",
  authDomain: "well-67432.firebaseapp.com",
  projectId: "well-67432"
});
const db = getFirestore(app);

// ‚≠ê —Ñ–æ–Ω
const stars = document.getElementById("stars");
for(let i=0;i<80;i++){
  const s=document.createElement("div");
  s.className="star";
  s.style.left=Math.random()*100+"%";
  s.style.top=Math.random()*100+"%";
  stars.appendChild(s);
}

const zone = document.getElementById("flightZone");
const inputBar = document.getElementById("inputBar");

function updateZone(){
  zone.style.bottom = inputBar.offsetHeight + "px";
}
updateZone();
addEventListener("resize", updateZone);

// üéà
const emojis = ['üéà','üéâ','‚ú®','üåü','üéÅ','üíù','üéÇ','üéä','üåà','üí´'];

const cards = new Map();
const MAX_CARDS = 120;

// Firebase (–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ)
const q = query(
  collection(db,"messages"),
  orderBy("timestamp"),
  limit(MAX_CARDS)
);

onSnapshot(q, snap => {
  snap.docChanges().forEach(change => {
    if(change.type === "added"){
      addCard(change.doc.id, change.doc.data());
    }
  });
});

function addCard(id, data){
  if(cards.size >= MAX_CARDS){
    const [oldest] = cards.keys();
    cards.get(oldest).el.remove();
    cards.delete(oldest);
  }

  const el = document.createElement("div");
  el.className = "wish-card";
  el.innerHTML = `
    <div class="wish-emoji">${emojis[Math.random()*emojis.length|0]}</div>
    <div class="wish-text">${data.text}</div>
    <div class="wish-author">‚Äî ${data.author || "–ê–Ω–æ–Ω–∏–º"}</div>
  `;

  zone.appendChild(el);

  const rect = zone.getBoundingClientRect();
  const card = {
    el,
    x: Math.random()*(rect.width-260),
    y: Math.random()*(rect.height-120),
    ax: 10+Math.random()*20,
    ay: 6+Math.random()*12,
    speed: 0.0003+Math.random()*0.0005,
    dragging: false,
    offsetX: 0,
    offsetY: 0
  };

  // ======== Drag & Hold ========
  let pointerId = null;

  const startDrag = e => {
    e.preventDefault();
    pointerId = e.pointerId;
    card.dragging = true;
    const rect = el.getBoundingClientRect();
    const clientX = e.clientX ?? e.touches?.[0]?.clientX;
    const clientY = e.clientY ?? e.touches?.[0]?.clientY;
    card.offsetX = clientX - rect.left;
    card.offsetY = clientY - rect.top;
  };

  const moveDrag = e => {
    if(!card.dragging) return;
    const clientX = e.clientX ?? e.touches?.[0]?.clientX;
    const clientY = e.clientY ?? e.touches?.[0]?.clientY;
    card.x = clientX - card.offsetX;
    card.y = clientY - card.offsetY;
    el.style.transform = `translate3d(${card.x}px,${card.y}px,0)`;
  };

  const endDrag = e => { card.dragging = false; pointerId = null; };

  el.addEventListener("pointerdown", startDrag);
  window.addEventListener("pointermove", moveDrag);
  window.addEventListener("pointerup", endDrag);
  el.addEventListener("pointercancel", endDrag);

  cards.set(id, card);
}

// üîÅ –æ–¥–∏–Ω animation loop
function animate(t){
  cards.forEach(c=>{
    if(!c.dragging){ // –¥–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –∑–∞–∂–∞–ª–∏
      const x = c.x + Math.sin(t*c.speed)*c.ax;
      const y = c.y + Math.cos(t*c.speed)*c.ay;
      c.el.style.transform = `translate3d(${x}px,${y}px,0)`;
    }
  });
  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

// ================== –§–ò–õ–¨–¢–† –ú–ê–¢–ê ==================
const russianBadWords = ["—Å—É–∫–∞", /* ... */];

function normalizeText(text){
  return text.toLowerCase()
    .replace(/\s+/g,"")
    .replace(/[^a-z–∞-—è—ë]/gi,"")
    .replace(/[aeiouyl]/g,c=>({a:"–∞",e:"–µ",i:"–∏",o:"–æ",u:"—É",y:"—É",l:"–ª"}[c]||c));
}

function containsBadWords(text){
  const n = normalizeText(text);
  return russianBadWords.some(w=>n.includes(w));
}

sendBtn.onclick = async ()=>{
  const text = wishInput.value.trim();
  if(!text) return;

  const author = nameInput.value.trim();
  if(containsBadWords(text) || containsBadWords(author)){
    alert("–°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞");
    return;
  }

  await addDoc(collection(db,"messages"),{
    text,
    author: author || "–ê–Ω–æ–Ω–∏–º",
    timestamp: new Date()
  });

  wishInput.value="";
  nameInput.value="";
};
</script>
</body>
</html>
